<!doctype html>
<html lang="en">
  <head>
   <!-- basic -->
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <!-- mobile metas -->
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <meta name="viewport" content="initial-scale=1, maximum-scale=1">
   <!-- site metas -->
   <title>Talleres CBTis258</title>
   <meta name="keywords" content="">
   <meta name="description" content="">
   <meta name="author" content="">
   <link rel="shortcut icon" href="images/image logo.png" title="Favicon"/>
   <!-- bootstrap css -->
   <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
   <!-- style css -->
   <link rel="stylesheet" type="text/css" href="css/style.css">
   <!-- Responsive-->
   <link rel="stylesheet" href="css/responsive.css">
   <!-- fevicon -->
   <link rel="icon" href="images/fevicon.png" type="image/gif" />
   <!-- Scrollbar Custom CSS -->
   <link rel="stylesheet" href="css/jquery.mCustomScrollbar.min.css">
   <!-- Tweaks for older IEs-->
   <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
   <!-- owl stylesheets --> 
   <link rel="stylesheet" href="css/owl.carousel.min.css">
   <link rel="stylesheet" href="css/owl.theme.default.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css" media="screen">
   <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="shortcut icon" href="images/image logo.png" title="Favicon"/>
  <link rel="stylesheet" href="css/Loginsesion.css">
  <title>login</title>
  </head>
  <body>
    <style>
        body { background-image: url("img-actu/alexa.jpeg");}
    </style>
    <div class="header_section">
      <!--barra de incio-->
      <nav class="navbar navbar-expand-lg navbar-light bg-light">  
         <a class="logo" href="index.html"><img src="images/logoop1.png"></a>
         <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
         <span class="navbar-toggler-icon"></span>
         </button>
         <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
               <li class="nav-item active">
                  <a class="nav-link" href="index.html">Principal</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="culturales.html">Culturales</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="deportes.html">Deportes</a>
               </li>
               <li class="nav-item">
                  <a class="nav-link" href="civicos.html">Civicos</a>
               </li>
            </ul>
          
            <div class="search_icon"><a href="login.html"><img src="images/user-icon.png"><span class="padding_left_15">Ingresar</span></a></div>
         </div>
      </nav>
      <!--cierre de barra-->
      <section class="form-register">
         <h4>Iniciar sesión</h4>
         <form id="loginForm">
             <input class="controls" type="email" name="email" id="email" placeholder="Ingrese su Correo" required>
             <input class="controls" type="password" name="password" id="password" placeholder="Ingrese su Contraseña" required>
             <p>Estoy de acuerdo con <a href="#">Términos y Condiciones</a></p>
             <button class="botons" type="submit">Entrar</button>
             <p><a href="#no-password">¿No recuerdo mi contraseña?</a></p>
             <p><a href="register.html">No tengo cuenta</a></p>
         </form>
     </section>
 
       <script src="./js/config.js"></script>


     <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
     
     <script>

        // Verificar si ya está autenticado
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            if (token) {
                // Si ya tiene token, verificar si es válido
                verifyToken(token);
            }
        });

        // Verificar validez del token
        async function verifyToken(token) {
            try {
                const response = await axios.get(`${API_BASE_URL}/auth/profile`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                
                // Si el token es válido, redirigir al dashboard correspondiente
                const user = response.data.user;
                redirectToDashboard(user.rol);
                
            } catch (error) {
                // Token inválido, remover de localStorage
                localStorage.removeItem('token');
            }
        }

        // Manejar el formulario de login
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Mostrar loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Ingresando...';
            
            try {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                const response = await axios.post(`${API_BASE_URL}/auth/login`, {
                    email: email,
                    password: password
                });
                
                // Guardar token
                localStorage.setItem('token', response.data.token);
                
                // Debug: verificar qué rol devuelve el backend
                console.log('Usuario logueado:', response.data.user);
                console.log('Tipo de usuario:', response.data.user.tipo_usuario);
                
                // Mostrar mensaje de éxito
                showNotification('¡Login exitoso! Redirigiendo...', 'success');
                
                // Redirigir según el rol
                setTimeout(() => {
                    redirectToDashboard(response.data.user.tipo_usuario);
                }, 1000);
                
            } catch (error) {
                console.error('Error en login:', error);
                
                let errorMessage = 'Error al iniciar sesión';
                if (error.response?.data?.message) {
                    errorMessage = error.response.data.message;
                } else if (error.response?.status === 401) {
                    errorMessage = 'Email o contraseña incorrectos';
                } else if (error.response?.status === 404) {
                    errorMessage = 'Usuario no encontrado';
                }
                
                showNotification(errorMessage, 'error');
                
            } finally {
                // Restaurar botón
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        // Redirigir según el rol del usuario
        function redirectToDashboard(rol) {
            console.log('Redirigiendo usuario con rol:', rol);
            
            switch(rol) {
                case 'admin':
                    console.log('Redirigiendo a dashboard admin');
                    window.location.href = 'dashboard-admin-system.html';
                    break;
                case 'instructor':
                    console.log('Redirigiendo a dashboard instructor');
                    window.location.href = 'dashboard-instructor.html';
                    break;
                case 'alumno':
                default:
                    console.log('Redirigiendo a dashboard usuario/alumno');
                    window.location.href = 'dashboard-user.html';
                    break;
            }
        }

        // Función para mostrar notificaciones
        function showNotification(message, type) {
            // Crear elemento de notificación
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 9999;
                max-width: 300px;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            // Estilos según el tipo
            if (type === 'success') {
                notification.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#dc3545';
            } else {
                notification.style.backgroundColor = '#17a2b8';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animar entrada
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remover después de 4 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
    </script>
</html>